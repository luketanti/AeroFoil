{% extends "base.html" %}
{% block content %}
{% include 'nav.html' %}

<div class="setting-body">
    <div class="row g-0">
        <!-- Sidebar Navigation -->
        <div class="col-md-3 col-lg-2 border-end" id="settingsSidebar">
            <div class="d-flex align-items-center justify-content-between p-3 border-bottom">
                <h5 class="mb-0">Settings</h5>
                <button class="btn btn-sm d-md-none" type="button" id="sidebarToggle" aria-label="Toggle sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
            </div>
            <nav class="nav flex-column p-2" id="settingsNav">
                <a class="nav-link active" href="#" data-section="library">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 0.5rem;">
                        <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.81 8.985.936 8 1.783z"/>
                    </svg>
                    Library
                </a>
                <a class="nav-link" href="#" data-section="shop">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 0.5rem;">
                        <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
                    </svg>
                    Shop
                </a>
                <a class="nav-link" href="#" data-section="downloads">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 0.5rem;">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Downloads
                </a>
            </nav>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-md-9 col-lg-10">
            <!-- Mobile menu button -->
            <div class="d-md-none p-3 border-bottom">
                <button class="btn btn-outline-secondary" type="button" id="sidebarToggleMobile" aria-label="Toggle sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em; margin-right: 0.5rem;">
                        <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    Menu
                </button>
            </div>
            <div class="settings-container container-fluid mt-3">

                <div class="d-flex justify-content-end">
                    <div class="text-muted small">Version {{ app_version }}</div>
                </div>

                <!-- <h1>Settings</h1> -->

                {% if admin_account_created == false %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">Missing admin account!</h4>
                    <p>AeroFoil requires an admin account to enable authentication. Until an account with admin rights is
                        created, <strong>authentication is disabled, anyone can access and change the configuration of
                            your shop!</strong>
                        <br>
                        Add an admin account <a href="/users" class="alert-link">on the Users page</a>.
                    </p>
                </div>
                {% endif %}

                {% if valid_keys == false %}
                <div id="missingKeysAlert" class="alert alert-warning alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading">Missing console keys!</h4>
                    Console keys are required to decrypt any Nintendo content, including
                    backups. AeroFoil uses this to identify files, regardless of the filename.</br>
                    <strong>Titles will be missed or misidentified if you don't fill in your keys!</strong>
                    See <a target="_blank" href="https://gitlab.com/easyhacking/switch/-/wikis/home/getting-started/dump-keys" class="alert-link">this guide</a> on
                    how to extract the
                    keys from your console, and upload them <a href="/settings#consoleKeysInput" class="alert-link">here
                        in AeroFoil.</a>
                    <hr>
                    If keys are missing, all files <strong>must follow the format "Title Name
                        [TITLEID][vVERSION]"</strong>, else the file won't be recognized.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <div id="missingShopHostAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                    <h4 class="alert-heading">Missing shop Host!</h4>
                    Host verification from outside the local network is disabled if the shop <code>Host</code> is
                    missing, configure it <a href="/settings#shopHostInput" class="alert-link">here
                        in AeroFoil</a> to prevent someone else stealing from your shop.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div id="missingShopHauthAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="display: none;">
                    <h4 class="alert-heading">Missing shop Hauth!</h4>
                    <a href="https://blawar.github.io/tinfoil/network/#host-signature" class="alert-link"
                        target="_blank">Host signature</a> verification from outside the local network is disabled if
                    the shop <code>Hauth</code> is missing. Connect to the shop from Tinfoil with an admin account to
                    set it.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Library Section -->
                <div class="settings-section" id="section-library" data-section="library">
                <h2 class="pb-3">Library</h2>

                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="libraryAutoMaintenanceCheck" onChange="submitLibrarySettings()">
                    <label class="form-check-label" for="libraryAutoMaintenanceCheck">Auto-maintain library</label>
                    <div class="form-text">Runs library organization and removes empty folders on a schedule.</div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="libraryMaintenanceIntervalInput" class="form-label">Maintenance interval (minutes)</label>
                        <input type="number" min="30" class="form-control" id="libraryMaintenanceIntervalInput" onChange="submitLibrarySettings()">
                        <div class="form-text">Minimum 30 minutes. Values below 30 are clamped.</div>
                    </div>
                    <div class="col-md-5 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="libraryMaintenanceDeleteUpdatesCheck" onChange="submitLibrarySettings()">
                            <label class="form-check-label" for="libraryMaintenanceDeleteUpdatesCheck">Delete older updates during maintenance</label>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div>
                            <div class="form-text">Last maintenance run</div>
                            <div id="libraryMaintenanceLastRun" class="small text-muted">Never</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
                            <div class="flex-grow-1" style="min-width: 220px;">
                                <label for="libraryNamingTemplateSelect" class="form-label mb-1">Organization naming template</label>
                                <select id="libraryNamingTemplateSelect" class="form-select" onchange="onLibraryNamingTemplateChange()"></select>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-primary" onclick="addLibraryNamingTemplate()">Add template</button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteLibraryNamingTemplate()">Delete template</button>
                            </div>
                        </div>

                        <div class="form-text mb-3">
                            Tokens: <code>{title}</code>, <code>{title_id}</code>, <code>{app_id}</code>, <code>{version}</code>, <code>{version_txt}</code>, <code>{dlc_name}</code>, <code>{ext}</code> (<code>{version_txt}</code> applies to filename templates only)
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyLibraryNamingPreset('default')">Use Default Preset</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyLibraryNamingPreset('flat')">Use Flat Preset</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyLibraryNamingPreset('scene')">Use Scene Preset</button>
                        </div>

                        <div class="mb-3">
                            <button
                                class="btn btn-sm btn-success"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapseLibraryTemplateFields"
                                aria-expanded="false"
                                aria-controls="collapseLibraryTemplateFields">
                                Show template fields
                            </button>
                        </div>

                        <div class="collapse" id="collapseLibraryTemplateFields">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="libraryTemplateBaseFolderInput" class="form-label">Base folder template</label>
                                    <input id="libraryTemplateBaseFolderInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateBaseFilenameInput" class="form-label">Base filename template</label>
                                    <input id="libraryTemplateBaseFilenameInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateUpdateFolderInput" class="form-label">Update folder template</label>
                                    <input id="libraryTemplateUpdateFolderInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateUpdateFilenameInput" class="form-label">Update filename template</label>
                                    <input id="libraryTemplateUpdateFilenameInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateDlcFolderInput" class="form-label">DLC folder template</label>
                                    <input id="libraryTemplateDlcFolderInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateDlcFilenameInput" class="form-label">DLC filename template</label>
                                    <input id="libraryTemplateDlcFilenameInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateOtherFolderInput" class="form-label">Other folder template</label>
                                    <input id="libraryTemplateOtherFolderInput" class="form-control" type="text">
                                </div>
                                <div class="col-md-6">
                                    <label for="libraryTemplateOtherFilenameInput" class="form-label">Other filename template</label>
                                    <input id="libraryTemplateOtherFilenameInput" class="form-control" type="text">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <label class="form-label">Library paths:</label>
                <div id="libraryPathHelp" class="form-text">Path of directory containing your games.</div>
                <table class="table table-hover caption-top" id="pathsTable">
                    <thead>
                        <tr>
                            <th scope="col">Path</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

                <!-- Library buttons -->
                <div class="row g-3">
                    <div class="col-auto">
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseNewPath" aria-expanded="false" aria-controls="collapseNewPath">
                            Add library path
                        </button>
                    </div>

                    <div class="col-auto">
                        <button type="button" class="btn btn-primary mb-3 scanBtn" onClick='scanLibrary()'>Scan
                            library</button>
                    </div>
                </div>

                <div class="collapse" id="collapseNewPath">
                    <div class="card card-body">
                        <label class="form-label">Add a new directory:</label>
                        <div class="row g-3">
                            <div class="col-6">
                                <input type="text" class="form-control" id="libraryPathInput" placeholder="Path">
                            </div>
                            <div class="col-auto">
                                <button type="button" id="submitNewLibraryPathBtn" class="btn btn-primary mb-3"
                                    onClick='submitNewLibraryPath()'>Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete User Modal -->
                <div class="modal fade" id="deletePathModal" tabindex="-1" aria-labelledby="deletePathModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="deletePathModalLabel">Delete library path</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ...
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-4">

                <h3 class="pb-3">Title Identification</h3>
                <p class="text-muted">Titles identification configuration.</p>
                <div class="row mb-3">
                    <div class="col">
                        <label for="selectRegion" class="form-label">Library Region:</label>
                        <select id="selectRegion" class="form-select" aria-label="Select library region">
                        </select>
                    </div>
                    <div class="col">
                        <label for="selectLanguage" class="form-label">Library Language:</label>
                        <select id="selectLanguage" class="form-select" aria-label="Select library language">
                        </select>
                    </div>
                    <div id="selectRegionLanguageHelp" class="form-text">Region and Language used to get games
                        informations.</div>
                </div>

                <div class="mb-3">
                    <label for="consoleKeysInput" class="form-label">Console keys:</label>
                    <input class="form-control {% if valid_keys == true %}is-valid{% endif %}" type="file"
                        accept=".keys,.txt" id="consoleKeysInput">
                    <div class="valid-feedback">
                        Keys are valid!
                    </div>
                    <div id="invalidConsoleKeysFeedback" class="invalid-feedback">
                        Invalid keys file!
                    </div>
                    <div id="consoleKeysHelp" class="form-text">Console keys are required to decrypt any Nintendo
                        content, including
                        backups. AeroFoil uses this to identify files, regardless of the filename.
                    </div>
                </div>

                <div class="mb-3">
                    <button type="button" id="submitTitlesSettingsBtn" class="btn btn-primary"
                        onClick='submitTitlesSettings()'>Submit</button>
                </div>
                <div class="mb-3 d-flex align-items-center gap-3">
                    <button type="button" id="refreshMediaCacheBtn" class="btn btn-outline-secondary"
                        onClick='refreshMediaCache()'>Refresh icons and banners</button>
                    <button type="button" id="prefetchIconsBtn" class="btn btn-outline-secondary"
                        onClick='prefetchAllIcons()'>Prefetch all icons</button>
                    <button type="button" id="prefetchBannersBtn" class="btn btn-outline-secondary"
                        onClick='prefetchAllBanners()'>Prefetch all banners</button>
                    <span id="refreshMediaCacheStatus" class="text-muted small"></span>
                </div>
                </form>
                </div>

                <!-- Shop Section -->
                <div class="settings-section d-none" id="section-shop" data-section="shop">
                <h2 class="pb-3">Shop</h2>
                <!-- Shop URL -->
                <div class="mb-3">
                    <label for="shopHostInput" class="form-label">Shop URL:</label>
                    <input class="form-control" id="shopHostInput" aria-describedby="shopHostHelp"
                        placeholder="shop.domain.tld">
                    <div id="shopHostHelp" class="form-text">Configure your shop URL to enable host verification.<br>
                        Host verification from Tinfoil requests will be enforced if the shop is accessed securely (with
                        <code>https</code>), make sure your reverse proxy <strong>does NOT</strong> allow insecure
                        connections (or upgrades them to use SSL) and correctly sets the <code>X-Forwarded-Proto</code>
                        header.
                    </div>
                </div>
                <div class="mb-3">
                    <label for="shopHauthInput" class="form-label">Shop Hauth:</label>
                    <input class="form-control" id="shopHauthInput" aria-describedby="shopHauthHelp"
                        placeholder="Hauth value">
                    <div id="shopHauthHelp" class="form-text">Override the host signature (Hauth) used for Tinfoil verification.</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="publicShopCheck"
                        aria-describedby="publicShopCheckHelp">
                    <label class="form-check-label" for="publicShopCheck">Public shop</label>
                    <div id="publicShopCheckHelp" class="form-text">If enabled, Shop access from Tinfoil does not
                        require authentication.
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="externalTinfoilOnlyCheck"
                        aria-describedby="externalTinfoilOnlyCheckHelp">
                    <label class="form-check-label" for="externalTinfoilOnlyCheck">External access: Tinfoil/CyberFoil only</label>
                    <div id="externalTinfoilOnlyCheckHelp" class="form-text">If enabled, requests from external/public IP addresses are allowed only for Tinfoil/CyberFoil shop clients (detected by the Tinfoil header set and/or matching <code>User-Agent</code>). Private/local network access is unchanged.</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="encryptShopCheck"
                        aria-describedby="encryptShopCheckHelp">
                    <label class="form-check-label" for="encryptShopCheck">Encrypt shop</label>
                    <div id="encryptShopCheckHelp" class="form-text">Serve encrypted and compressed shop, so that only Tinfoil clients
                        can access the content. <strong>Strongly suggested to enable it for security</strong>.</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="fastTransferModeCheck"
                        aria-describedby="fastTransferModeCheckHelp">
                    <label class="form-check-label" for="fastTransferModeCheck">Fast transfer mode</label>
                    <div id="fastTransferModeCheckHelp" class="form-text">
                        Prioritize throughput by skipping per-chunk transfer tracking. Activity live byte counters and exact transfer byte accounting may be less precise.
                    </div>
                </div>
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Login Protection</h6>
                        <div class="form-check form-switch mb-3">
                            <input type="checkbox" class="form-check-input" id="authIpLockoutEnabledCheck">
                            <label class="form-check-label" for="authIpLockoutEnabledCheck">Enable failed-login IP lockout</label>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="authIpLockoutThresholdInput" class="form-label">Failed attempts</label>
                                <input type="number" min="1" max="1000" class="form-control" id="authIpLockoutThresholdInput">
                            </div>
                            <div class="col-md-4">
                                <label for="authIpLockoutWindowInput" class="form-label">Window (seconds)</label>
                                <input type="number" min="10" max="86400" class="form-control" id="authIpLockoutWindowInput">
                            </div>
                            <div class="col-md-4">
                                <label for="authIpLockoutDurationInput" class="form-label">Lockout (seconds)</label>
                                <input type="number" min="10" max="604800" class="form-control" id="authIpLockoutDurationInput">
                            </div>
                        </div>
                        <div>
                            <label for="authPermanentIpBlacklistInput" class="form-label">Permanent IP blacklist</label>
                            <textarea class="form-control font-monospace" id="authPermanentIpBlacklistInput" rows="4"
                                placeholder="203.0.113.4&#10;198.51.100.0/24"></textarea>
                            <div class="form-text">One IP or CIDR per line. Blacklisted clients cannot authenticate.</div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label for="shopPublicKeyInput" class="form-label mb-0">Public Key:</label>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#shopPublicKeyCollapse" aria-expanded="false" aria-controls="shopPublicKeyCollapse">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em;">
                                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                </svg>
                                Show
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="copyPublicKeyBtn" onclick="copyPublicKey()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em;">
                                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                                </svg>
                                Copy
                            </button>
                        </div>
                    </div>
                    <div class="collapse" id="shopPublicKeyCollapse">
                        <textarea class="form-control font-monospace" id="shopPublicKeyInput" rows="7"
                            aria-describedby="shopPublicKeyHelp" placeholder="-----BEGIN PUBLIC KEY-----"></textarea>
                    </div>
                    <div id="shopPublicKeyHelp" class="form-text">Public key used to encrypt the shop payload for Tinfoil clients.
                        Changing this will break encrypted shop access unless clients have the matching private key.</div>
                </div>

                <div class="mb-3">
                    <label for="motdTextArea" class="form-label">Message of the day:</label>
                    <textarea class="form-control" id="motdTextArea" rows="3"></textarea>
                    <div id="motdTextAreaHelp" class="form-text">Message presented when opening Tinfoil after
                        successfully loading your shop.</div>
                </div>

                <div class="mb-3">
                    <button type="button" id="submitShopSettingsBtn" class="btn btn-primary"
                        onClick='submitShopSettings()'>Submit</button>
                </div>
                </div>

                <!-- Downloads Section -->
                <div class="settings-section d-none" id="section-downloads" data-section="downloads">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0">Downloads</h2>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="downloadsEnabledCheck">
                        <label class="form-check-label" for="downloadsEnabledCheck">Enable automatic downloads</label>
                    </div>
                </div>

                <!-- Tab navigation -->
                <ul class="nav nav-tabs mb-3" id="downloadsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="prowlarr-tab" data-bs-toggle="tab" data-bs-target="#prowlarr" type="button" role="tab" aria-controls="prowlarr" aria-selected="false">Prowlarr</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="torrent-tab" data-bs-toggle="tab" data-bs-target="#torrent" type="button" role="tab" aria-controls="torrent" aria-selected="false">Torrent Client</button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content" id="downloadsTabContent">
                    <!-- General tab -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="downloadsIntervalInput" class="form-label">Search interval (minutes)</label>
                                <input type="number" min="5" class="form-control" id="downloadsIntervalInput">
                            </div>
                            <div class="col-md-4">
                                <label for="downloadsMinSeedersInput" class="form-label">Minimum seeders</label>
                                <input type="number" min="0" class="form-control" id="downloadsMinSeedersInput">
                            </div>
                            <div class="col-md-4">
                                <label for="downloadsCategoryInput" class="form-label">Torrent category/tag</label>
                                <input type="text" class="form-control" id="downloadsCategoryInput" placeholder="aerofoil">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="downloadsRequiredTermsInput" class="form-label">Required terms (comma separated)</label>
                                <input type="text" class="form-control" id="downloadsRequiredTermsInput">
                            </div>
                            <div class="col-md-6">
                                <label for="downloadsBlacklistTermsInput" class="form-label">Blacklist terms (comma separated)</label>
                                <input type="text" class="form-control" id="downloadsBlacklistTermsInput">
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="downloadsSearchPrefixInput" class="form-label">Search prefix</label>
                                <input type="text" class="form-control" id="downloadsSearchPrefixInput">
                            </div>
                            <div class="col-md-6">
                                <label for="downloadsSearchSuffixInput" class="form-label">Search suffix</label>
                                <input type="text" class="form-control" id="downloadsSearchSuffixInput">
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-12">
                                <label for="downloadsSearchCharReplacementsInput" class="form-label">Search character replacements</label>
                                <textarea class="form-control" id="downloadsSearchCharReplacementsInput" rows="4" placeholder="™=&gt;&#10;®=&gt;&#10;’=&gt;'"></textarea>
                                <div class="form-text">One rule per line in the form <code>from=&gt;to</code>. Leave <code>to</code> empty to remove the character.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Prowlarr tab -->
                    <div class="tab-pane fade" id="prowlarr" role="tabpanel" aria-labelledby="prowlarr-tab">
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="prowlarrUrlInput" class="form-label">Prowlarr URL</label>
                                <input type="text" class="form-control" id="prowlarrUrlInput" placeholder="http://localhost:9696">
                            </div>
                            <div class="col-md-6">
                                <label for="prowlarrApiKeyInput" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="prowlarrApiKeyInput">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="prowlarrTimeoutInput" class="form-label">Prowlarr timeout (seconds)</label>
                            <input type="number" min="5" max="180" class="form-control" id="prowlarrTimeoutInput" value="15">
                            <div class="form-text">Increase this if searches sometimes time out. Range: 5-180 seconds.</div>
                        </div>
                        <div class="mb-3">
                            <label for="prowlarrIndexerIdsInput" class="form-label">Indexer IDs (comma separated)</label>
                            <input type="text" class="form-control" id="prowlarrIndexerIdsInput" placeholder="1,2,3">
                        </div>
                        <div class="mb-3">
                            <label for="prowlarrCategoriesInput" class="form-label">Categories (comma separated)</label>
                            <input type="text" class="form-control" id="prowlarrCategoriesInput" placeholder="5000,5070">
                            <div class="form-text">Use numeric category IDs from Prowlarr.</div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <button type="button" id="testProwlarrBtn" class="btn btn-outline-secondary"
                                onClick='testProwlarrSettings()'>Test Prowlarr</button>
                            <span id="prowlarrTestResult" class="text-muted small"></span>
                        </div>
                    </div>

                    <!-- Torrent Client tab -->
                    <div class="tab-pane fade" id="torrent" role="tabpanel" aria-labelledby="torrent-tab">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label for="torrentClientTypeSelect" class="form-label">Client</label>
                                <select class="form-select" id="torrentClientTypeSelect">
                                    <option value="qbittorrent">qBittorrent</option>
                                    <option value="transmission">Transmission</option>
                                    <option value="deluge">Deluge</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label for="torrentClientUrlInput" class="form-label">Client URL</label>
                                <input type="text" class="form-control" id="torrentClientUrlInput" placeholder="http://localhost:8080">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="torrentClientUserInput" class="form-label">Username</label>
                                <input type="text" class="form-control" id="torrentClientUserInput">
                            </div>
                            <div class="col-md-6">
                                <label for="torrentClientPasswordInput" class="form-label">Password</label>
                                <input type="password" class="form-control" id="torrentClientPasswordInput">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="torrentClientPathInput" class="form-label">Download path (optional)</label>
                            <input type="text" class="form-control" id="torrentClientPathInput" placeholder="D:\\Downloads\\Switch">
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <button type="button" id="testTorrentClientBtn" class="btn btn-outline-secondary"
                                onClick='testTorrentClientSettings()'>Test torrent client</button>
                            <span id="torrentClientTestResult" class="text-muted small"></span>
                        </div>
                    </div>
                </div>

                <!-- Submit button -->
                <div class="mt-3">
                    <button type="button" id="submitDownloadSettingsBtn" class="btn btn-primary"
                        onClick='submitDownloadSettings()'>Save Settings</button>
                </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>

    settings_map = {
        'library/path': 'libraryPathInput'
    };


    // allUsers = [];

    function getInputVal(inputId) {
        return $("#" + inputId).val();
    };

    function setInputVal(inputId, value) {
        return $("#" + inputId).val(value);
    };

    function getCheckboxStatus(checkboxId) {
        return $('#' + checkboxId).is(":checked")
    }

    const DEFAULT_LIBRARY_NAMING_TEMPLATE = {
        base: {
            folder: "{title} [{title_id}]/Base",
            filename: "{title} [{title_id}] [BASE][v{version}].{ext}"
        },
        update: {
            folder: "{title} [{title_id}]/Updates/v{version}",
            filename: "{title} [{app_id}] [UPDATE][v{version}].{ext}"
        },
        dlc: {
            folder: "{title} [{title_id}]/DLC/{dlc_name} [{app_id}]",
            filename: "{title} - {dlc_name} [{app_id}] [DLC][v{version}].{ext}"
        },
        other: {
            folder: "{title} [{title_id}]/Other",
            filename: "{title} [{title_id}] [UNKNOWN].{ext}"
        }
    };

    const LIBRARY_NAMING_PRESETS = {
        default: JSON.parse(JSON.stringify(DEFAULT_LIBRARY_NAMING_TEMPLATE)),
        flat: {
            base: {
                folder: ".",
                filename: "{title} [{title_id}] [BASE][v{version}].{ext}"
            },
            update: {
                folder: ".",
                filename: "{title} [{title_id}] [UPDATE][v{version}].{ext}"
            },
            dlc: {
                folder: ".",
                filename: "{title} - {dlc_name} [{app_id}] [DLC][v{version}].{ext}"
            },
            other: {
                folder: ".",
                filename: "{title} [{title_id}] [UNKNOWN].{ext}"
            }
        },
        scene: {
            base: {
                folder: "{title} [{title_id}]",
                filename: "{title} [{title_id}] [v{version}] [BASE].{ext}"
            },
            update: {
                folder: "{title} [{title_id}]/Updates",
                filename: "{title} [{title_id}] [UPDATE][v{version}].{ext}"
            },
            dlc: {
                folder: "{title} [{title_id}]/DLC",
                filename: "{title} [{title_id}] - {dlc_name} [{app_id}] [DLC][v{version}].{ext}"
            },
            other: {
                folder: "{title} [{title_id}]/Other",
                filename: "{title} [{title_id}] [UNKNOWN].{ext}"
            }
        }
    };

    let libraryNamingTemplatesState = {
        active: 'default',
        templates: { default: JSON.parse(JSON.stringify(DEFAULT_LIBRARY_NAMING_TEMPLATE)) }
    };

    function normalizeLibraryNamingTemplates(raw) {
        const fallback = {
            active: 'default',
            templates: { default: JSON.parse(JSON.stringify(DEFAULT_LIBRARY_NAMING_TEMPLATE)) }
        };
        if (!raw || typeof raw !== 'object') {
            return fallback;
        }
        const templatesRaw = raw.templates && typeof raw.templates === 'object' ? raw.templates : {};
        const templates = {};
        Object.keys(templatesRaw).forEach(name => {
            const entry = templatesRaw[name] || {};
            templates[name] = {
                base: {
                    folder: String(entry.base?.folder || DEFAULT_LIBRARY_NAMING_TEMPLATE.base.folder),
                    filename: String(entry.base?.filename || DEFAULT_LIBRARY_NAMING_TEMPLATE.base.filename),
                },
                update: {
                    folder: String(entry.update?.folder || DEFAULT_LIBRARY_NAMING_TEMPLATE.update.folder),
                    filename: String(entry.update?.filename || DEFAULT_LIBRARY_NAMING_TEMPLATE.update.filename),
                },
                dlc: {
                    folder: String(entry.dlc?.folder || DEFAULT_LIBRARY_NAMING_TEMPLATE.dlc.folder),
                    filename: String(entry.dlc?.filename || DEFAULT_LIBRARY_NAMING_TEMPLATE.dlc.filename),
                },
                other: {
                    folder: String(entry.other?.folder || DEFAULT_LIBRARY_NAMING_TEMPLATE.other.folder),
                    filename: String(entry.other?.filename || DEFAULT_LIBRARY_NAMING_TEMPLATE.other.filename),
                }
            };
        });
        if (!Object.keys(templates).length) {
            return fallback;
        }
        const active = templates[raw.active] ? raw.active : Object.keys(templates)[0];
        return { active: active, templates: templates };
    }

    function writeLibraryTemplateInputs(template) {
        const t = template || DEFAULT_LIBRARY_NAMING_TEMPLATE;
        setInputVal("libraryTemplateBaseFolderInput", t.base.folder);
        setInputVal("libraryTemplateBaseFilenameInput", t.base.filename);
        setInputVal("libraryTemplateUpdateFolderInput", t.update.folder);
        setInputVal("libraryTemplateUpdateFilenameInput", t.update.filename);
        setInputVal("libraryTemplateDlcFolderInput", t.dlc.folder);
        setInputVal("libraryTemplateDlcFilenameInput", t.dlc.filename);
        setInputVal("libraryTemplateOtherFolderInput", t.other.folder);
        setInputVal("libraryTemplateOtherFilenameInput", t.other.filename);
    }

    function saveActiveLibraryTemplateInputs() {
        const active = libraryNamingTemplatesState.active;
        if (!active || !libraryNamingTemplatesState.templates[active]) {
            return;
        }
        libraryNamingTemplatesState.templates[active] = {
            base: {
                folder: getInputVal("libraryTemplateBaseFolderInput"),
                filename: getInputVal("libraryTemplateBaseFilenameInput"),
            },
            update: {
                folder: getInputVal("libraryTemplateUpdateFolderInput"),
                filename: getInputVal("libraryTemplateUpdateFilenameInput"),
            },
            dlc: {
                folder: getInputVal("libraryTemplateDlcFolderInput"),
                filename: getInputVal("libraryTemplateDlcFilenameInput"),
            },
            other: {
                folder: getInputVal("libraryTemplateOtherFolderInput"),
                filename: getInputVal("libraryTemplateOtherFilenameInput"),
            },
        };
    }

    function renderLibraryNamingTemplateSelect() {
        const select = $('#libraryNamingTemplateSelect');
        select.empty();
        Object.keys(libraryNamingTemplatesState.templates).forEach(name => {
            const selected = name === libraryNamingTemplatesState.active ? 'selected' : '';
            select.append(`<option value="${name}" ${selected}>${name}</option>`);
        });
        writeLibraryTemplateInputs(libraryNamingTemplatesState.templates[libraryNamingTemplatesState.active]);
    }

    function onLibraryNamingTemplateChange() {
        saveActiveLibraryTemplateInputs();
        libraryNamingTemplatesState.active = getInputVal("libraryNamingTemplateSelect");
        writeLibraryTemplateInputs(libraryNamingTemplatesState.templates[libraryNamingTemplatesState.active]);
    }

    function addLibraryNamingTemplate() {
        saveActiveLibraryTemplateInputs();
        const name = (window.prompt('New template name:') || '').trim();
        if (!name) {
            return;
        }
        if (libraryNamingTemplatesState.templates[name]) {
            alert('Template already exists.');
            return;
        }
        const source = libraryNamingTemplatesState.templates[libraryNamingTemplatesState.active] || DEFAULT_LIBRARY_NAMING_TEMPLATE;
        libraryNamingTemplatesState.templates[name] = JSON.parse(JSON.stringify(source));
        libraryNamingTemplatesState.active = name;
        renderLibraryNamingTemplateSelect();
        submitLibrarySettings();
    }

    function deleteLibraryNamingTemplate() {
        saveActiveLibraryTemplateInputs();
        const names = Object.keys(libraryNamingTemplatesState.templates);
        if (names.length <= 1) {
            alert('At least one naming template is required.');
            return;
        }
        const active = libraryNamingTemplatesState.active;
        delete libraryNamingTemplatesState.templates[active];
        libraryNamingTemplatesState.active = Object.keys(libraryNamingTemplatesState.templates)[0];
        renderLibraryNamingTemplateSelect();
        submitLibrarySettings();
    }

    function applyLibraryNamingPreset(presetName) {
        const preset = LIBRARY_NAMING_PRESETS[presetName];
        if (!preset) {
            return;
        }
        const active = libraryNamingTemplatesState.active;
        if (!active || !libraryNamingTemplatesState.templates[active]) {
            return;
        }
        libraryNamingTemplatesState.templates[active] = JSON.parse(JSON.stringify(preset));
        writeLibraryTemplateInputs(libraryNamingTemplatesState.templates[active]);
        submitLibrarySettings();
    }

    function scanLibrary(path = null) {
        $('.scanBtn').prop('disabled', true);
        data = {
            path: path
        }
        $.ajax({
            url: '/api/library/scan',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    if (result['status_code'] == '302') {
                        window.location.href = result['location']
                        return
                    }
                    console.log('Scan Success!');
                }
                $('.scanBtn').prop('disabled', false);
            }
        });

    }

    function fillLibraryTable() {
        $('#pathsTable tbody').empty();

        $.getJSON("/api/settings/library/paths", function (result) {

            if (!result['success']) {
                if (result['status_code'] == '302') {
                    window.location.href = result['location']
                    return
                }
            }
            paths = result.paths;
            if (paths === null || !paths.length) {
                $('#pathsTable tbody').append(
                    '<tr><td>-</td><td>-</td><td>');
            } else {
                paths.forEach(path => {
                    $('#pathsTable tbody').append(
                        '<tr><td>' + path + '</td>'
                        + '<td>' +
                        '<button type="button" class="btn btn-outline-info btn-sm scanBtn" onclick=\'scanLibrary("' + path + '");\' ><i class="bi bi-arrow-clockwise"></i></button> ' +
                        '<button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deletePathModal" data-bs-path="' + path + '"\'><i class="bi bi-x-circle"></i></button>' +
                        '</td></tr>');
                })
            }
        });

    }

    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-title]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            const existing = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
            if (existing) {
                existing.dispose();
            }
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    const deletePathModal = $('#deletePathModal')
    if (deletePathModal) {
        deletePathModal.on('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const path = button.getAttribute('data-bs-path')
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.

            // Update the modal's content.
            // const modalTitle = deletePathModal.querySelector('.modal-title')
            const modalBody = deletePathModal.find('.modal-body')
            const deleteBtn = deletePathModal.find('.btn-danger')


            deleteBtn.attr('onClick', 'deleteLibraryPath("' + path + '");');

            // modalTitle.textContent = `New message to ${recipient}`
            modalBody.text("Delete path " + path + " ?")
        })
    }

    function deleteLibraryPath(path) {
        data = {
            path: path
        }
        $.ajax({
            url: "/api/settings/library/paths",
            type: 'DELETE',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    fillLibraryTable();
                }
            }
        });
    }

    function submitNewLibraryPath() {
        $('#submitNewLibraryPathBtn').prop('disabled', true);
        path = getInputVal("libraryPathInput").trim();
        data = {
            path: path
        }

        $.ajax({
            url: "/api/settings/library/paths",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (result['success']) {
                    if (result['status_code'] == '302') {
                        window.location.href = result['location']
                        return
                    }
                    console.log('Sucessfully added path ' + path);
                    setInputVal("libraryPathInput", "")
                    fillLibraryTable();
                } else {
                    console.log('Error adding path ' + path);
                }
                $('#submitNewLibraryPathBtn').prop('disabled', false);
            }
        });
    }

    function submitTitlesSettings() {
        $('#submitTitlesSettingsBtn').prop('disabled', true);
        data = {
            region: getInputVal("selectRegion"),
            language: getInputVal("selectLanguage"),
        }
        file = $('#consoleKeysInput').prop('files')[0];

        if (file != undefined) {
            formData = new FormData();
            formData.append("file", file);
            $.ajax({
                url: "/api/upload",
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                success: function (result) {
                    if (result['success']) {
                        $('#consoleKeysInput').removeClass('is-invalid');
                        $('#consoleKeysInput').addClass('is-valid');
                        $('#missingKeysAlert').addClass('d-none');
                    } else {
                        $('#invalidConsoleKeysFeedback').text("Invalid keys file! Invalid keys detected: " + result['errors'].join(', '));
                        $('#consoleKeysInput').addClass('is-invalid');
                    }
                }
            });
        }

        $.ajax({
            url: "/api/settings/titles",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (!result['success']) {
                    console.log('Not Success!');
                    result['errors'].forEach(error => {
                        path = error['path'];
                        formId = settings_map[path];
                        form = $('#' + formId);
                        form.addClass('is-invalid');
                        formTextElement = form.attr('aria-describedby');
                        $("#" + formTextElement).addClass('invalid-feedback');
                        $("#" + formTextElement).text(error['error']);
                    });
                }
                $('#submitTitlesSettingsBtn').prop('disabled', false);
            }
        });
    }

    function refreshMediaCache() {
        const statusEl = $('#refreshMediaCacheStatus');
        statusEl.text('Refreshing cache...');
        $('#refreshMediaCacheBtn').prop('disabled', true);
        $('#prefetchIconsBtn').prop('disabled', true);
        $('#prefetchBannersBtn').prop('disabled', true);
        $.ajax({
            url: "/api/settings/media-cache/refresh",
            type: 'POST',
            data: JSON.stringify({ icons: true, banners: true }),
            contentType: "application/json",
            success: function (result) {
                if (result && result['success']) {
                    const icons = result['removed_icons'] ?? 0;
                    const banners = result['removed_banners'] ?? 0;
                    statusEl.text(`Cleared ${icons} icons and ${banners} banners.`);
                } else {
                    statusEl.text('Refresh failed.');
                }
            },
            error: function () {
                statusEl.text('Refresh failed.');
            },
            complete: function () {
                $('#refreshMediaCacheBtn').prop('disabled', false);
                $('#prefetchIconsBtn').prop('disabled', false);
                $('#prefetchBannersBtn').prop('disabled', false);
            }
        });
    }

    function prefetchAllIcons() {
        const statusEl = $('#refreshMediaCacheStatus');
        statusEl.text('Prefetching icons...');
        $('#prefetchIconsBtn').prop('disabled', true);
        $('#refreshMediaCacheBtn').prop('disabled', true);
        $('#prefetchBannersBtn').prop('disabled', true);
        $.ajax({
            url: "/api/settings/media-cache/prefetch-icons",
            type: 'POST',
            contentType: "application/json",
            success: function (result) {
                if (result && result['success']) {
                    const fetched = result['fetched'] ?? 0;
                    const skipped = result['skipped'] ?? 0;
                    const missing = result['missing'] ?? 0;
                    const failed = result['failed'] ?? 0;
                    const failures = result['failures'] || [];
                    statusEl.text(`Prefetched ${fetched} icons. Skipped ${skipped}, missing ${missing}, failed ${failed}.`);
                    if (failures.length) {
                        console.warn('Icon prefetch failures:', failures);
                        statusEl.text(`${statusEl.text()} See console for sample errors.`);
                    }
                } else {
                    statusEl.text('Prefetch failed.');
                }
            },
            error: function () {
                statusEl.text('Prefetch failed.');
            },
            complete: function () {
                $('#prefetchIconsBtn').prop('disabled', false);
                $('#refreshMediaCacheBtn').prop('disabled', false);
                $('#prefetchBannersBtn').prop('disabled', false);
            }
        });
    }

    function prefetchAllBanners() {
        const statusEl = $('#refreshMediaCacheStatus');
        statusEl.text('Prefetching banners...');
        $('#prefetchBannersBtn').prop('disabled', true);
        $('#refreshMediaCacheBtn').prop('disabled', true);
        $('#prefetchIconsBtn').prop('disabled', true);
        $.ajax({
            url: "/api/settings/media-cache/prefetch-banners",
            type: 'POST',
            contentType: "application/json",
            success: function (result) {
                if (result && result['success']) {
                    const fetched = result['fetched'] ?? 0;
                    const skipped = result['skipped'] ?? 0;
                    const missing = result['missing'] ?? 0;
                    const failed = result['failed'] ?? 0;
                    const failures = result['failures'] || [];
                    statusEl.text(`Prefetched ${fetched} banners. Skipped ${skipped}, missing ${missing}, failed ${failed}.`);
                    if (failures.length) {
                        console.warn('Banner prefetch failures:', failures);
                        statusEl.text(`${statusEl.text()} See console for sample errors.`);
                    }
                } else {
                    statusEl.text('Prefetch failed.');
                }
            },
            error: function () {
                statusEl.text('Prefetch failed.');
            },
            complete: function () {
                $('#prefetchBannersBtn').prop('disabled', false);
                $('#refreshMediaCacheBtn').prop('disabled', false);
                $('#prefetchIconsBtn').prop('disabled', false);
            }
        });
    }

    function submitShopSettings() {
        $('#submitShopSettingsBtn').prop('disabled', true);
        const threshold = parsePositiveInt(getInputVal("authIpLockoutThresholdInput"), 5);
        const windowSeconds = parsePositiveInt(getInputVal("authIpLockoutWindowInput"), 600);
        const durationSeconds = parsePositiveInt(getInputVal("authIpLockoutDurationInput"), 1800);
        data = {
            host: $('#shopHostInput').val(),
            hauth: $('#shopHauthInput').val(),
            public: getCheckboxStatus("publicShopCheck"),
            external_tinfoil_only: getCheckboxStatus("externalTinfoilOnlyCheck"),
            encrypt: getCheckboxStatus("encryptShopCheck"),
            fast_transfer_mode: getCheckboxStatus("fastTransferModeCheck"),
            auth_ip_lockout_enabled: getCheckboxStatus("authIpLockoutEnabledCheck"),
            auth_ip_lockout_threshold: threshold,
            auth_ip_lockout_window_seconds: windowSeconds,
            auth_ip_lockout_duration_seconds: durationSeconds,
            auth_permanent_ip_blacklist: parseIpEntryList(getInputVal("authPermanentIpBlacklistInput")),
            public_key: getInputVal("shopPublicKeyInput"),
            motd: $('#motdTextArea').val(),
        }

        $.ajax({
            url: "/api/settings/shop",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (!result['success']) {
                    console.log('Not Success!');
                    result['errors'].forEach(error => {
                        path = error['path'];
                        formId = settings_map[path];
                        form = $('#' + formId);
                        form.addClass('is-invalid');
                        formTextElement = form.attr('aria-describedby');
                        $("#" + formTextElement).addClass('invalid-feedback');
                        $("#" + formTextElement).text(error['error']);
                    });
                }
                $('#submitShopSettingsBtn').prop('disabled', false);
            }
        });
    }

    function splitTerms(value) {
        if (!value) {
            return [];
        }
        return value.split(',').map(item => item.trim()).filter(Boolean);
    }

    function parsePositiveInt(value, fallback) {
        const out = parseInt(value, 10);
        if (!Number.isFinite(out) || out <= 0) {
            return fallback;
        }
        return out;
    }

    function parseIpEntryList(value) {
        if (!value) {
            return [];
        }
        const seen = new Set();
        const out = [];
        String(value).replaceAll('\r', '\n').replaceAll(',', '\n').split('\n').forEach(raw => {
            const token = String(raw || '').trim();
            if (!token) {
                return;
            }
            const key = token.toLowerCase();
            if (seen.has(key)) {
                return;
            }
            seen.add(key);
            out.push(token);
        });
        return out;
    }

    function formatIpEntryList(entries) {
        if (!Array.isArray(entries)) {
            return '';
        }
        return entries.map(item => String(item || '').trim()).filter(Boolean).join('\n');
    }

    function parseSearchCharReplacements(value) {
        if (!value) {
            return [];
        }
        const rules = [];
        const seen = new Set();
        value.split('\n').forEach(line => {
            const raw = (line || '').trim();
            if (!raw) {
                return;
            }
            let fromText = raw;
            let toText = '';
            if (raw.includes('=>')) {
                const parts = raw.split('=>');
                fromText = (parts.shift() || '').trim();
                toText = parts.join('=>').trim();
            } else if (raw.includes('=')) {
                const parts = raw.split('=');
                fromText = (parts.shift() || '').trim();
                toText = parts.join('=').trim();
            }
            if (!fromText || seen.has(fromText)) {
                return;
            }
            rules.push({ from: fromText, to: toText });
            seen.add(fromText);
        });
        return rules;
    }

    function formatSearchCharReplacements(rules) {
        if (!Array.isArray(rules) || !rules.length) {
            return '';
        }
        return rules
            .map(rule => `${rule?.from || ''}=>${rule?.to || ''}`)
            .filter(line => !line.startsWith('=>'))
            .join('\n');
    }

    function parseIndexerIds(value) {
        if (!value) {
            return [];
        }
        return value.split(',').map(item => parseInt(item.trim(), 10)).filter(id => !isNaN(id));
    }

    function parseProwlarrCategories(value) {
        if (!value) {
            return { values: [], invalid: [] };
        }
        const tokens = value.split(',').map(item => item.trim()).filter(item => item.length > 0);
        const invalid = tokens.filter(item => !/^\d+$/.test(item));
        const values = tokens.filter(item => /^\d+$/.test(item));
        return { values: values, invalid: invalid };
    }

    function updateTorrentClientFieldState() {
        const clientType = getInputVal("torrentClientTypeSelect");
        const usernameInput = $("#torrentClientUserInput");
        const isDeluge = clientType === "deluge";
        usernameInput.prop("disabled", isDeluge);
        if (isDeluge) {
            usernameInput.attr("placeholder", "Not required for Deluge");
        } else {
            usernameInput.attr("placeholder", "");
        }
    }

    function copyPublicKey() {
        const publicKeyInput = document.getElementById('shopPublicKeyInput');
        const publicKey = publicKeyInput.value;
        
        if (!publicKey) {
            alert('No public key to copy.');
            return;
        }
        
        navigator.clipboard.writeText(publicKey).then(function() {
            const btn = document.getElementById('copyPublicKeyBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em;"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg> Copied';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            setTimeout(function() {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(function(err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy to clipboard.');
        });
    }

    function submitDownloadSettings() {
        $('#submitDownloadSettingsBtn').prop('disabled', true);
        const categoriesParsed = parseProwlarrCategories(getInputVal("prowlarrCategoriesInput"));
        let prowlarrTimeout = parseInt(getInputVal("prowlarrTimeoutInput"), 10);
        if (isNaN(prowlarrTimeout)) {
            prowlarrTimeout = 15;
        }
        prowlarrTimeout = Math.max(5, Math.min(180, prowlarrTimeout));
        setInputVal("prowlarrTimeoutInput", prowlarrTimeout);
        if (categoriesParsed.invalid.length) {
            alert('Prowlarr categories must be numeric IDs only. Invalid values: ' + categoriesParsed.invalid.join(', '));
            $('#submitDownloadSettingsBtn').prop('disabled', false);
            return;
        }
        data = {
            enabled: getCheckboxStatus("downloadsEnabledCheck"),
            interval_minutes: parseInt(getInputVal("downloadsIntervalInput"), 10),
            min_seeders: parseInt(getInputVal("downloadsMinSeedersInput"), 10),
            required_terms: splitTerms(getInputVal("downloadsRequiredTermsInput")),
            blacklist_terms: splitTerms(getInputVal("downloadsBlacklistTermsInput")),
            search_prefix: getInputVal("downloadsSearchPrefixInput"),
            search_suffix: getInputVal("downloadsSearchSuffixInput"),
            search_char_replacements: parseSearchCharReplacements(getInputVal("downloadsSearchCharReplacementsInput")),
            prowlarr: {
                url: getInputVal("prowlarrUrlInput"),
                api_key: getInputVal("prowlarrApiKeyInput"),
                indexer_ids: parseIndexerIds(getInputVal("prowlarrIndexerIdsInput")),
                categories: categoriesParsed.values,
                timeout_seconds: prowlarrTimeout
            },
            torrent_client: {
                type: getInputVal("torrentClientTypeSelect"),
                url: getInputVal("torrentClientUrlInput"),
                username: getInputVal("torrentClientUserInput"),
                password: getInputVal("torrentClientPasswordInput"),
                category: getInputVal("downloadsCategoryInput"),
                download_path: getInputVal("torrentClientPathInput")
            }
        };

        $.ajax({
            url: "/api/settings/downloads",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                if (!result['success']) {
                    console.log('Not Success!');
                }
            },
            complete: function () {
                $('#submitDownloadSettingsBtn').prop('disabled', false);
            }
        });
    }

    function submitLibrarySettings() {
        let intervalVal = parseInt(getInputVal("libraryMaintenanceIntervalInput"), 10);
        if (isNaN(intervalVal)) {
            intervalVal = 720;
        }
        intervalVal = Math.max(30, intervalVal);
        setInputVal("libraryMaintenanceIntervalInput", intervalVal);
        saveActiveLibraryTemplateInputs();
        const payload = {
            auto_maintenance: getCheckboxStatus("libraryAutoMaintenanceCheck"),
            maintenance_interval_minutes: intervalVal,
            maintenance_delete_updates: getCheckboxStatus("libraryMaintenanceDeleteUpdatesCheck"),
            naming_templates: libraryNamingTemplatesState,
        };
        $.ajax({
            url: "/api/settings/library",
            type: "POST",
            data: JSON.stringify(payload),
            contentType: "application/json",
            success: function () {
                console.log("Library settings saved.");
            }
        });
    }

    function testProwlarrSettings() {
        $('#testProwlarrBtn').prop('disabled', true);
        $('#prowlarrTestResult').text('Testing...').removeClass('text-danger text-success').addClass('text-muted');
        let prowlarrTimeout = parseInt(getInputVal("prowlarrTimeoutInput"), 10);
        if (isNaN(prowlarrTimeout)) {
            prowlarrTimeout = 15;
        }
        prowlarrTimeout = Math.max(5, Math.min(180, prowlarrTimeout));
        setInputVal("prowlarrTimeoutInput", prowlarrTimeout);
        data = {
            url: getInputVal("prowlarrUrlInput"),
            api_key: getInputVal("prowlarrApiKeyInput"),
            indexer_ids: parseIndexerIds(getInputVal("prowlarrIndexerIdsInput")),
            timeout_seconds: prowlarrTimeout
        };
        $.ajax({
            url: "/api/settings/downloads/test-prowlarr",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                const ok = result['success'];
                const warning = result['warning'];
                let text = result['message'] || (ok ? 'Prowlarr OK' : 'Prowlarr test failed');
                if (warning) {
                    text = `${text} (${warning})`;
                }
                $('#prowlarrTestResult')
                    .text(text)
                    .removeClass('text-muted text-danger text-success')
                    .addClass(ok ? 'text-success' : 'text-danger');
            },
            complete: function () {
                $('#testProwlarrBtn').prop('disabled', false);
            }
        });
    }

    function testTorrentClientSettings() {
        $('#testTorrentClientBtn').prop('disabled', true);
        $('#torrentClientTestResult').text('Testing...').removeClass('text-danger text-success').addClass('text-muted');
        data = {
            type: getInputVal("torrentClientTypeSelect"),
            url: getInputVal("torrentClientUrlInput"),
            username: getInputVal("torrentClientUserInput"),
            password: getInputVal("torrentClientPasswordInput"),
            download_path: getInputVal("torrentClientPathInput")
        };
        $.ajax({
            url: "/api/settings/downloads/test-client",
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (result) {
                const ok = result['success'];
                const warning = result['warning'];
                let text = result['message'] || (ok ? 'Torrent client OK' : 'Torrent client test failed');
                if (warning) {
                    text = `${text} (${warning})`;
                }
                $('#torrentClientTestResult')
                    .text(text)
                    .removeClass('text-muted text-danger text-success')
                    .addClass(ok ? 'text-success' : 'text-danger');
            },
            complete: function () {
                $('#testTorrentClientBtn').prop('disabled', false);
            }
        });
    }

    // Settings navigation
    function showSettingsSection(sectionName) {
        // Hide all sections
        $('.settings-section').addClass('d-none');
        
        // Show selected section
        $(`#section-${sectionName}`).removeClass('d-none');
        
        // Update nav links
        $('#settingsNav .nav-link').removeClass('active');
        $(`#settingsNav .nav-link[data-section="${sectionName}"]`).addClass('active');
        
        // Update URL hash
        window.location.hash = sectionName;
        
        // Close sidebar on mobile after selection
        if (window.innerWidth < 768) {
            $('#settingsSidebar').removeClass('show');
            $('body').removeClass('sidebar-open');
        }
    }
    
    // Handle navigation clicks
    $('#settingsNav .nav-link').on('click', function(e) {
        e.preventDefault();
        const section = $(this).data('section');
        showSettingsSection(section);
    });
    
    // Handle sidebar toggle on mobile
    $('#sidebarToggle, #sidebarToggleMobile').on('click', function(e) {
        e.stopPropagation();
        $('#settingsSidebar').toggleClass('show');
        $('body').toggleClass('sidebar-open');
    });

    // Close sidebar when clicking outside on mobile
    $(document).on('click', function(e) {
        if ($(window).width() < 768 && $('#settingsSidebar').hasClass('show')) {
            if (!$(e.target).closest('#settingsSidebar').length && 
                !$(e.target).is('#sidebarToggle') && 
                !$(e.target).is('#sidebarToggleMobile') &&
                !$(e.target).closest('#sidebarToggleMobile').length) {
                $('#settingsSidebar').removeClass('show');
                $('body').removeClass('sidebar-open');
            }
        }
    });
    
    // Handle URL hash for direct navigation
    function handleHashNavigation() {
        const hash = window.location.hash.substring(1);
        if (['library', 'shop', 'downloads'].includes(hash)) {
            showSettingsSection(hash);
        } else {
            // Default to library if no hash
            showSettingsSection('library');
        }
    }
    
    // Handle browser back/forward
    $(window).on('hashchange', handleHashNavigation);

    $(document).ready(function () {
        // Initialize settings navigation
        handleHashNavigation();
        
        fillLibraryTable();
        $("#torrentClientTypeSelect").on("change", updateTorrentClientFieldState);
        $('#libraryTemplateBaseFolderInput, #libraryTemplateBaseFilenameInput, #libraryTemplateUpdateFolderInput, #libraryTemplateUpdateFilenameInput, #libraryTemplateDlcFolderInput, #libraryTemplateDlcFilenameInput, #libraryTemplateOtherFolderInput, #libraryTemplateOtherFilenameInput')
            .on('change', function () { submitLibrarySettings(); });

        initTooltips();
        
        // Update collapse button text when toggled
        $('#shopPublicKeyCollapse').on('show.bs.collapse', function () {
            const btn = $(this).closest('.mb-3').find('[data-bs-toggle="collapse"]');
            btn.html('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em;"><path fill-rule="evenodd" d="M7.646 4.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 5.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/></svg> Hide');
        });
        $('#shopPublicKeyCollapse').on('hide.bs.collapse', function () {
            const btn = $(this).closest('.mb-3').find('[data-bs-toggle="collapse"]');
            btn.html('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -0.125em;"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg> Show');
        });

        $.getJSON("/api/settings", function (result) {
            Object.keys(languages).forEach(function (key) {
                $('#selectRegion').append(`<option value="${key}">${key}</option>`);
            });

            $('#selectRegion').on('change', function () {
                $('#selectLanguage').empty()
                region = $(this).find(":selected").val();
                availableLanguages = languages[region];
                availableLanguages.forEach(function (key) {
                    $('#selectLanguage').append(`<option value="${key}">${key}</option>`);
                });
            });


            // Library settings
            librarySettings = result['library'];
            $("#libraryAutoMaintenanceCheck").prop("checked", !!librarySettings['auto_maintenance']);
            setInputVal("libraryMaintenanceIntervalInput", librarySettings['maintenance_interval_minutes'] || 720);
            $("#libraryMaintenanceDeleteUpdatesCheck").prop("checked", librarySettings['maintenance_delete_updates'] !== false);
            libraryNamingTemplatesState = normalizeLibraryNamingTemplates(librarySettings['naming_templates']);
            renderLibraryNamingTemplateSelect();
            const maintenanceLastRun = librarySettings['maintenance_last_run'];
            if (maintenanceLastRun) {
                try {
                    const dt = new Date(maintenanceLastRun);
                    $('#libraryMaintenanceLastRun').text(dt.toLocaleString());
                } catch (e) {
                    $('#libraryMaintenanceLastRun').text(maintenanceLastRun);
                }
            } else {
                $('#libraryMaintenanceLastRun').text('Never');
            }
            // Titles settings
            titlesSettings = result['titles'];

            // Fill region and language
            setInputVal("selectRegion", titlesSettings['region']);
            $('#selectRegion').trigger('change');
            setInputVal("selectLanguage", titlesSettings['language']);

            // Shop settings
            shopSettings = result['shop'];
            setInputVal("shopHostInput", shopSettings['host']);
            setInputVal("shopHauthInput", shopSettings['hauth_value'] || '');
            setInputVal("motdTextArea", shopSettings['motd']);
            $("#publicShopCheck").prop("checked", shopSettings['public']);
            $("#externalTinfoilOnlyCheck").prop("checked", !!shopSettings['external_tinfoil_only']);
            $("#encryptShopCheck").prop("checked", shopSettings['encrypt']);
            $("#fastTransferModeCheck").prop("checked", !!shopSettings['fast_transfer_mode']);
            setInputVal("shopPublicKeyInput", shopSettings['public_key'] || '');
            securitySettings = result['security'] || {};
            $("#authIpLockoutEnabledCheck").prop("checked", securitySettings['auth_ip_lockout_enabled'] !== false);
            setInputVal("authIpLockoutThresholdInput", securitySettings['auth_ip_lockout_threshold'] || 5);
            setInputVal("authIpLockoutWindowInput", securitySettings['auth_ip_lockout_window_seconds'] || 600);
            setInputVal("authIpLockoutDurationInput", securitySettings['auth_ip_lockout_duration_seconds'] || 1800);
            setInputVal("authPermanentIpBlacklistInput", formatIpEntryList(securitySettings['auth_permanent_ip_blacklist'] || []));
            if (!shopSettings['host']) {
                $("#missingShopHostAlert").css('display', '');
            } else if (!shopSettings['hauth']) {
                $("#missingShopHauthAlert").css('display', '');
            }

            // Downloads settings
            downloadsSettings = result['downloads'] || {};
            setInputVal("downloadsIntervalInput", downloadsSettings['interval_minutes']);
            setInputVal("downloadsMinSeedersInput", downloadsSettings['min_seeders']);
            setInputVal("downloadsRequiredTermsInput", (downloadsSettings['required_terms'] || []).join(', '));
            setInputVal("downloadsBlacklistTermsInput", (downloadsSettings['blacklist_terms'] || []).join(', '));
            setInputVal("downloadsSearchPrefixInput", downloadsSettings['search_prefix'] || '');
            setInputVal("downloadsSearchSuffixInput", downloadsSettings['search_suffix'] || '');
            setInputVal(
                "downloadsSearchCharReplacementsInput",
                formatSearchCharReplacements(downloadsSettings['search_char_replacements'] || [])
            );
            $("#downloadsEnabledCheck").prop("checked", !!downloadsSettings['enabled']);
            setInputVal("downloadsCategoryInput", downloadsSettings['torrent_client']?.['category'] || 'aerofoil');

            prowlarrSettings = downloadsSettings['prowlarr'] || {};
            setInputVal("prowlarrUrlInput", prowlarrSettings['url'] || '');
            setInputVal("prowlarrApiKeyInput", prowlarrSettings['api_key'] || '');
            setInputVal("prowlarrIndexerIdsInput", (prowlarrSettings['indexer_ids'] || []).join(', '));
            setInputVal("prowlarrCategoriesInput", (prowlarrSettings['categories'] || []).join(', '));
            setInputVal("prowlarrTimeoutInput", prowlarrSettings['timeout_seconds'] || 15);

            torrentSettings = downloadsSettings['torrent_client'] || {};
            setInputVal("torrentClientTypeSelect", torrentSettings['type'] || 'qbittorrent');
            setInputVal("torrentClientUrlInput", torrentSettings['url'] || '');
            setInputVal("torrentClientUserInput", torrentSettings['username'] || '');
            setInputVal("torrentClientPasswordInput", torrentSettings['password'] || '');
            setInputVal("torrentClientPathInput", torrentSettings['download_path'] || '');
            updateTorrentClientFieldState();
        });

    });
    languages = {{ languages_from_titledb | tojson | safe }}
</script>

{% endblock %}

